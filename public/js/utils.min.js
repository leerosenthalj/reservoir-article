var historicalData,resNames=["ORO","CLE","INV","FOL","HID","DNP","BUC","ISB","SHA"],resTranslations={ORO:"Lake Oroville",CLE:"Trinity Lake",INV:"Indian Valley Res.",FOL:"Folsom Lake",HID:"Hensley Lake",DNP:"Don Pedro Res.",BUC:"Eastman Lake",ISB:"Lake Isabella",SHA:"Lake Shasta"},arc,gauges={};function drawMaps(){d3.json("california.json",function(c,f){makeMap("#map","historical-map",f),makeMap("#stat-wrapper","stat-map",f),drawReservoirs()})}function drawReservoirs(){d3.json("reservoir_data.json",function(c,f){placeReservoirs(f,"#historical-map",["ORO","CLE","INV","FOL","HID","DNP","BUC","ISB","SHA"]),placeReservoirs(f,"#stat-map",["DNP","FOL","HID","INV","ISB","ORO","SHA"],{SHA:["ORO","INV"],INV:["ORO","FOL"],FOL:["DNP"],DNP:["HID","ISB"]},"-stat")})}var stopXCoord,pauseXCoord,curtain;function loadHistoricalData(){d3.json("historical_data.json",function(c,f){makeFillGauges(f,70,70,12,"#gauges"),makeSlider(f,"#slider-inner-div","slider-inner"),makeColorCodeDivs(f,"#slider-inner-div");makeLineChart("#buchanan-wrapper",f,{resNames:["BUC"],resColors:["#0DC1F2"],beginDate:"January 2003",endDate:"November 2016",pauseDate:"November 2012",stopDate:"November 2016"},function(h){curtain=h.curtain,stopXCoord=h.stopDateXCoord,pauseXCoord=h.pauseDateXCoord,curtain.transition().duration(3e3).ease("linear").attr("x",pauseXCoord)})})}function rewindBuchananChart(){var c=d3.select("#curtain");c&&c.transition().duration(1e3).ease("linear").attr("x",pauseXCoord)}function advanceBuchananChart(){var c=d3.select("#curtain");c&&c.transition().duration(1e3).ease("linear").attr("x",stopXCoord)}function makeWaterBuckets(c,f,g,h,k,l,m){for(var o=d3.select(c).append("svg").attr("viewBox","0 0 "+k+" "+l).attr("id","buckets"),p=Math.min(k/f,l/g),q=p/8,r=p-2*q,u=1,w=0;w<g;w+=1)for(var A,z=0;z<f;z+=1)A=o.append("rect").attr("x",q/2+z*p).attr("y",q/2+w*p).attr("width",r).attr("height",r).attr("fill","#0D7AC4").attr("id","bucket"+u).attr("class","bucket"),u++;var B=p*g,C=o.append("rect").attr("x",q/2).attr("y",B+m/2).attr("width",r).attr("height",r).attr("fill","#0D7AC4"),D=o.append("text").text("= "+h+" gallons").attr("x",p+q/2).attr("y",B+m/2+r-q).attr("font-size",18).attr("class","label"),E=o.append("text").text(f*g*h+" gallons remaining").attr("x",k/2-100).attr("y",B+m/2+r-q).attr("font-size",18).attr("class","label").attr("id","gallons-remaining")}function updateWaterBuckets(c,f,g,h){for(var m=Math.round((f*g*h-c)/h),o=1;o<=m;o++)$("#bucket"+o).attr("fill","#CCC");for(var o=m+1;o<f*g;o++)$("#bucket"+o).attr("fill","#0D7AC4");$("#gallons-remaining").text(c+" gallons remaining")}function PDSIText(c,f){return $("<h2 id='"+c+"'>"+f+"</h2>")}function PDSILabels(){return $("<div class='slider-labels'><p id='label-neg5'>-5</p><p id='label-neg4'>-4</p><p id='label-neg3'>-3</p><p id='label-neg2'>-2</p><p id='label-neg1'>-1</p><p id='label-0'>0</p><p id='label-1'>1</p><p id='label-2'>2</p><p id='label-3'>3</p><p id='label-4'>4</p><p id='label-5'>5</p></div>")}function makePDSISlider(c,f,g,h,k,l,m){k||(k=0),""!=f&&$("#"+c).append(PDSIText(f,g));var o;l?(o=$("<div id='"+h+"' class='slider pdsi-slider'></div>"),o.append($("<div id='"+m+"' class='slider-indicator'></div>"))):o=$("<input type='range' id='"+h+"' min='-5' max='5' value='"+k+"' class='slider pdsi-slider' oninput='updatePDSILabel(this.value, \""+f+"\")'>"),$("#"+c).append(o),$("#"+c).append(PDSILabels())}function makePDSIGraphic(c){var f=$("<div class='slider pdsi-slider'></div>");$("#"+c).append(f),$("#"+c).append(PDSILabels())}function updatePDSILabel(c,f){-5==c?$("#"+f).text("Extreme Drought"):-4==c?$("#"+f).text("Extreme Drought"):-3==c?$("#"+f).text("Severe Drought"):-2==c?$("#"+f).text("Moderate Drought"):-1==c?$("#"+f).text("Mid-Range"):0==c?$("#"+f).text("Mid-Range"):1==c?$("#"+f).text("Mid-Range"):2==c?$("#"+f).text("Moderately Moist"):3==c?$("#"+f).text("Very Moist"):4==c?$("#"+f).text("Extremely Moist"):$("#"+f).text("Extremely Moist")}function makeFillGaugeForPDSISlider(){var c=$("<svg class='gaugeSVG' id='dependency-gauge' width='100' height='100' style='width: 100px; height: 100px;'></svg>");$("#dependency-viz").append(c);var f=makeFillGauge("dependency-gauge",80);setTimeout(function g(){$("#pdsi-indicator").animate({left:"20%"},2e3,function(){f.update(20),setTimeout(function(){$("#pdsi-indicator").animate({left:"80%"},2e3,function(){f.update(80),setTimeout(g,2500)})},2500)})},1e3)}function makeReservoirFillGraphic(){var c=liquidFillGaugeDefaultSettings();c.circleThickness=0.05,c.circleColor="#0D7AC4",c.textColor="#0000",c.waveTextColor="#0000",c.waveColor="#0D7AC4",c.textVertPosition=0.8,c.waveAnimateTime=2e3,c.waveRiseTime=1500,c.waveHeight=0.05,c.waveAnimate=!0,c.waveRise=!1,c.waveHeightScaling=!1,c.waveOffset=0.25,c.textSize=0.9,c.waveCount=2,c.valueCountUp=!1;var f=makeFillGauge("reservoir-filling",50,c),g="orange";setTimeout(function h(){$("#input-line-1").css("stroke-dashoffset",0),$("#input-line-2").css("stroke-dashoffset",0),$("#input-line-3").css("stroke-dashoffset",0),f.update(80),d3.select("#input-line-1").transition().duration(500).style("stroke",g),d3.select("#input-line-2").transition().duration(500).style("stroke",g),d3.select("#input-line-3").transition().duration(500).style("stroke",g),$(".input-line").animate({strokeDashoffset:"-100",stroke:g},1500,function(){d3.select("#input-line-1").transition().duration(500).style("stroke","black"),d3.select("#input-line-2").transition().duration(500).style("stroke","black"),d3.select("#input-line-3").transition().duration(500).style("stroke","black")}),setTimeout(function(){$("#output-line-1").css("stroke-dashoffset",0),$("#output-line-2").css("stroke-dashoffset",0),$("#output-line-3").css("stroke-dashoffset",0),f.update(20),d3.select("#output-line-1").transition().duration(500).style("stroke",g),d3.select("#output-line-2").transition().duration(500).style("stroke",g),d3.select("#output-line-3").transition().duration(500).style("stroke",g),$(".output-line").animate({strokeDashoffset:"-100",stroke:g},1500,function(){d3.select("#output-line-1").transition().duration(500).style("stroke","black"),d3.select("#output-line-2").transition().duration(500).style("stroke","black"),d3.select("#output-line-3").transition().duration(500).style("stroke","black")}),setTimeout(h,3e3)},3e3)},1e3)}function makeMultipleFillGauge(){var c=makeFillGauge("connected-res-a",10),f=makeFillGauge("connected-res-b",37),g=makeFillGauge("connected-res-c",22),h="orange";setTimeout(function k(){$("#connect-line-1").css("stroke-dashoffset","0"),$("#connect-line-2").css("stroke-dashoffset","0"),$("#connect-line-3").css("stroke-dashoffset","0"),$("#output-line-b").css("stroke-dashoffset","0"),$("#output-line-c").css("stroke-dashoffset","0"),c.update(90),d3.select("#connect-line-1").transition().duration(500).style("stroke",h),$("#connect-line-1").animate({strokeDashoffset:"-100",stroke:h},1500,function(){d3.select("#connect-line-1").transition().duration(500).style("stroke","black"),setTimeout(function(){c.update(10),d3.select("#connect-line-2").transition().duration(500).style("stroke",h),d3.select("#connect-line-3").transition().duration(500).style("stroke",h),$("#connect-line-2").animate({strokeDashoffset:"-100"},1500,function(){d3.select("#connect-line-2").transition().duration(500).style("stroke","black")}),$("#connect-line-3").animate({strokeDashoffset:"-100"},1500,function(){d3.select("#connect-line-3").transition().duration(500).style("stroke","black")}),f.update(76),g.update(55)},1e3),setTimeout(function(){f.update(37),g.update(22),d3.select("#output-line-b").transition().duration(500).style("stroke",h),d3.select("#output-line-c").transition().duration(500).style("stroke",h),$("#output-line-b").animate({strokeDashoffset:"-100"},1500,function(){d3.select("#output-line-b").transition().duration(500).style("stroke","black")}),$("#output-line-c").animate({strokeDashoffset:"-100"},1500,function(){d3.select("#output-line-c").transition().duration(500).style("stroke","black")}),setTimeout(k,3e3)},3e3)})},1e3)}function makeFillGauges(c,f,g,h,k){historicalData=c;var l=0;for(var m in c[0])if("PDSI"!=m){if("date"==m){$("#date").text(c[0][m]);continue}if(l>=h)break;var o=100*(l%3),p=25;2<l&&6>l?p=150:6<=l&&(p=275);var q=$("<svg class='chart' viewBox='0 0 100 125' x='"+o+"' y='"+p+"' width='100' height='125' style='width: 90px; height: 90px; overflow: visible;'></svg>");$(k).append(q);var r=$("<svg style='overflow: visible; width: 90px;'><text text-anchor='middle' x='45' y='20' height='100' fill='black' class='res-name' id='label-"+m+"'>"+resTranslations[m]+"</text></svg>"),u="chart-"+m,w=$("<svg class='chartSVG' id='"+u+"' y='25'></svg>");q.append(w),q.append(r),w.mouseover(function(A){var B=A.target.id.split("-")[1];$("#"+B).attr("style","fill: orange; stroke: orange;"),$("#"+A.target.id+" circle").attr("style","fill: orange;"),$("#"+A.target.id+" path").attr("style","fill: orange;")}),w.mouseout(function(A){var B=A.target.id.split("-")[1];$("#"+B).attr("style","fill: #FFF; stroke: #FFF;"),$("#"+A.target.id+" circle").attr("style","fill: #0D7AC4;"),$("#"+A.target.id+" path").attr("style","fill: #0D7AC4;")});var z=makeFillGauge(u,c[0][m][0].percent);gauges[m]=z,l++}}function makeSlider(c,f){var h=$("<h3 id='date'>January 2003</h3>"),k=c.length-1,l=$("<input id='slidey' type='range' min='0' max='"+k+"' value='0' class='slider' oninput='updateData(this.value);$(\"#click-here-div\").css(\"opacity\", 0);' onchange='updateData(this.value);' list='drought-markers'>"),m=$("<datalist id='drought-markers'><option>67</option><option>139</option></datalist>");$("#slider").append(h),$(f).append(l),$(f).append(m)}var numSliderDivs=0;function makeColorCodeDivs(c,f){var g=$(f);g.css("position","relative");var h=g.width(),k=g.height();numSliderDivs=c.length;var l=h/c.length,m=0,o=1;for(var p of c){var q=p.date,r=p.PDSI,u=getPDSIColor(r),w=$("<div id='slider-div-"+o+"'></div>");w.css("width",l),w.css("height",k),w.css("position","absolute"),w.css("background-color",u),w.css("left",m),w.css("top",0),w.css("z-index",0),w.css("pointer-events","none"),g.append(w),m+=l,o++}}function resizeColorCodeDivs(){for(var k,c=$("#slider-inner-div").width(),f=c/numSliderDivs,g=0,h=1;h<=numSliderDivs;h++)k=$("#slider-div-"+h),k.css("left",g),k.css("width",f),g+=f}function getPDSIColor(c){return-4>=c?"#D17D00":-3>=c?"#FFA620":-2>=c?"#FFD496":2>c?"#EEE":3>c?"#A4DAFF":4>c?"#4C9BD1":"#095385"}function updateData(c){$("#date").text(historicalData[c].date);for(var f=0;f<resNames.length;f++){var g=gauges[resNames[f]],h=historicalData[c][resNames[f]][0].percent;g.update(h.toFixed(1))}}function arcTween(c){var f=d3.interpolate(this._current,c);return this._current=f(0),function(g){return arc(f(g))}}var width=300,height=300,scale=1215,projection=d3.geo.mercator().center([-119.3,37.6]).scale(scale).translate([width/2,height/2]);function makeMap(c,f,g){var h=d3.select(c).append("svg").attr("viewBox","-10 -15 "+width+" "+height).attr("id",f),k=d3.geo.path().projection(projection);h.selectAll(".ca").data(g).enter().append("path").attr("d",k).attr("stroke","#0D7AC4").attr("fill","#0D7AC4").attr("stroke-width","1")}function placeReservoirs(c,f,g,h,k){k||(k="");var l=c.filter(function(D){return g.includes(D.Name)}),m={};for(var o of l)m[o.Name]=projection([o.Longitude,o.Latitude]);if(h){for(var p in h){var q=m[p][0],r=m[p][1];for(var u of h[p]){var w=m[u][0],z=m[u][1],A=p+"-"+u;"DNP"==p?"HID"==u?d3.select(f).append("path").attr("d","M"+q+" "+r+" C 130 150, 130 160, "+w+" "+z).attr("stroke-width",3).attr("stroke","white").attr("fill","transparent").attr("id",A).attr("class",p+" "+u):d3.select(f).append("path").attr("d","M"+q+" "+r+" C 110 170, 130 200, "+w+" "+z).attr("stroke-width",3).attr("stroke","white").attr("fill","transparent").attr("id",A).attr("class",p+" "+u):d3.select(f).append("line").style("stroke-width",3).style("stroke","white").attr("x1",q).attr("y1",r).attr("x2",w).attr("y2",z).attr("id",A).attr("class",p+" "+u)}}for(var B=["Drought Index (PDSI),","Agricultural Demand,","Snowpack, etc."],C=0;C<B.length;C++)d3.select(f).append("text").attr("x",178).attr("y",70+16*C).attr("class","res-dependencies label").style("font-size","12px").text(B[C]);for(var o in m)d3.select(f).append("line").attr("x1",175).attr("y1",85).attr("x2",m[o][0]).attr("y2",m[o][1]).attr("stroke","orange").attr("stroke-dasharray","3 3").attr("stroke-width","2")}d3.select(f).selectAll(".res").data(c.filter(function(D){return g.includes(D.Name)})).enter().append("circle").attr("cx",function(D){return projection([D.Longitude,D.Latitude])[0]}).attr("cy",function(D){return projection([D.Longitude,D.Latitude])[1]}).attr("r","3px").attr("fill","#FFF").attr("stroke","none").attr("id",function(D){return k?D.Name+k:D.Name}).attr("class","res"+k).on("mouseover",reservoirMouseover).on("mouseout",reservoirMouseout)}var tooltip=d3.select("body").append("div").attr("class","tooltip").style("opacity",1).style("border-radius","8px");function makeTooltipHTML(c){var f=c.LakeName+" ("+c.Name+")";return"<p><strong>"+f+"</strong></p>"}function reservoirMouseover(c){tooltip.transition().duration(200).style("opacity",0.9),tooltip.html(makeTooltipHTML(c)).style("left",d3.event.pageX+"px").style("top",d3.event.pageY-30+"px").transition().duration(500).style("opacity",1).style("pointer-events","auto"),$("#chart-"+c.Name+" circle").attr("style","fill: orange;"),$("#chart-"+c.Name+" path").attr("style","fill: orange;"),$("#"+c.Name).attr("style","fill: orange; stroke: orange;")}function reservoirMouseout(c){tooltip.transition().duration(500).style("opacity",0).style("pointer-events","none"),$("#chart-"+c.Name+" circle").attr("style","fill: #0D7AC4;"),$("#chart-"+c.Name+" path").attr("style","fill: #0D7AC4;"),$("#"+c.Name).attr("style","fill: #FFF; stroke: #FFF;")}function connectedResMouseover(c){tooltip.transition().duration(100).style("opacity",0.9),tooltip.html(makeTooltipHTML(c)).style("left",d3.event.pageX+"px").style("top",d3.event.pageY-30+"px").style("color","white").style("background-color","rgba(0, 0, 0, 0.5)").style("pointer-events","auto")}function connectedResMouseout(){tooltip.transition().duration(100).style("opacity",0).style("pointer-events","none")}function defaultLineChartConfig(){return{resNames:["SHA"],resColors:["#0D7AC4"],beginDate:"January 2003",endDate:"December 2016",pauseDate:"June 2008",stopDate:"December 2016"}}function makeLineChart(c,f,g,h){var k=g.resNames,l=g.resColors,m=g.beginDate,o=g.endDate,p=g.pauseDate,q=g.stopDate,r={top:45,right:60,bottom:75,left:80},u=500,w=200,z=u+r.left+r.right,A=w+r.top+r.bottom,B=d3.select(c).append("svg").attr("viewBox","0 0 "+z+" "+A).attr("id","line-graph").append("g").attr("transform","translate("+r.left+","+r.top+")"),C=d3.time.scale().rangeRound([0,u]),D=d3.scale.linear().rangeRound([w,0]),E=d3.svg.axis().scale(C).orient("bottom").tickSize(8).ticks(d3.timeYear);B.append("text").attr("transform","translate("+u/2+" ,"+(w+55)+")").style("text-anchor","middle").attr("class","label").style("font-size",20).text("Date");var F=d3.svg.axis().scale(D).orient("left").ticks(4);B.append("text").attr("transform","rotate(-90)").attr("y",0-r.left+15).attr("x",0-w/2).attr("dy","1em").style("text-anchor","middle").attr("class","label").style("font-size",20).text("Percent Full");for(var I,G=d3.time.format("%B %Y").parse,H=f.length-1;0<=H;H--)I=G(f[H].date),(I<G(m)||I>G(o))&&f.splice(H,1);C.domain([G(m),G(o)]),D.domain([0,100]);for(var J=C(G(p)),K=C(G(q)),H=0;H<k.length;H++)var M=k[H],N=l[H],O=d3.svg.line().x(function(U){return C(G(U.date))}).y(function(U){return D(U[M][0].percent)}),P=B.append("path").attr("class","line").attr("fill","none").attr("stroke",N).attr("stroke-width",4).attr("d",O(f));var Q=B.append("rect").attr("fill","#F5F5F5").attr("stroke","none").attr("width",u+r.right).attr("height",w).attr("x",0).attr("id","curtain");B.append("g").attr("class","x axis").attr("transform","translate(0,"+w+")").call(E),B.append("g").attr("class","y axis").call(F);for(var R=B.append("rect").attr("width",r.right).attr("height",17*k.length+5).attr("fill","#F5F5F5").attr("x",u-10).attr("y",(w-17*k.length+5)/2),H=0;H<k.length;H++)var S=B.append("rect").attr("width",12).attr("height",12).attr("fill",l[H]).attr("x",u).attr("y",(w-17*k.length+5)/2+17*H+5),T=B.append("text").text(k[H]).attr("x",u+15).attr("y",(w-17*k.length+5)/2+17*H+15).attr("font-size",12).attr("class","label");h({curtain:Q,stopDateXCoord:K,pauseDateXCoord:J})}function makeFillGauge(c,f,g){var h;return g?h=g:(h=liquidFillGaugeDefaultSettings(),h.circleThickness=0.05,h.circleColor="#0D7AC4",h.textColor="#000",h.waveTextColor="#000",h.waveColor="#0D7AC4",h.textVertPosition=0.8,h.waveAnimateTime=2e3,h.waveRiseTime=1500,h.waveHeight=0.05,h.waveAnimate=!0,h.waveRise=!1,h.waveHeightScaling=!1,h.waveOffset=0.25,h.textSize=0.9,h.waveCount=2,h.valueCountUp=!1),loadLiquidFillGauge(c,f,h)}